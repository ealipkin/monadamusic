var songs = [
  {
    id: '3',
    duration: '3:12',
    name: 'SOS',
    artist: 'МОНАДА',
    audio: 'audio/leteli_na_yug/01_sos.mp3',
    cover: 'images/covers/leteli_na_yug.jpg',
    color: 'white',
    links: {
      itunes: 'https://apple.co/2xrMNr4',
      google: 'http://bit.ly/2Nt9ZQw',
      yandex: 'http://bit.ly/326H2wL',
    }
  },
  {
    id: '3',
    duration: '3:41',
    name: 'Все не так',
    artist: 'МОНАДА',
    audio: 'audio/leteli_na_yug/02_vse_ne_tak.mp3',
    cover: 'images/covers/leteli_na_yug.jpg',
    color: 'white',
    links: {
      itunes: 'https://apple.co/2xrMNr4',
      google: 'http://bit.ly/2Nt9ZQw',
      yandex: 'http://bit.ly/326H2wL',
    }
  },
  {
    id: '3',
    duration: '3:18',
    name: 'Стены знают',
    artist: 'МОНАДА',
    audio: 'audio/leteli_na_yug/03_steni_znayut.mp3',
    cover: 'images/covers/leteli_na_yug.jpg',
    color: 'white',
    links: {
      itunes: 'https://apple.co/2xrMNr4',
      google: 'http://bit.ly/2Nt9ZQw',
      yandex: 'http://bit.ly/326H2wL',
    }
  },
  {
    id: '3',
    duration: '3:31',
    name: 'Вакуум',
    artist: 'МОНАДА',
    audio: 'audio/leteli_na_yug/04_vakuum.mp3',
    cover: 'images/covers/leteli_na_yug.jpg',
    color: 'white',
    links: {
      itunes: 'https://apple.co/2xrMNr4',
      google: 'http://bit.ly/2Nt9ZQw',
      yandex: 'http://bit.ly/326H2wL',
    }
  },
  {
    id: '3',
    duration: '3:35',
    name: 'Летели на Юг',
    artist: 'МОНАДА',
    audio: 'audio/leteli_na_yug/05_leteli_na_yug.mp3',
    cover: 'images/covers/leteli_na_yug.jpg',
    color: 'white',
    links: {
      itunes: 'https://apple.co/2xrMNr4',
      google: 'http://bit.ly/2Nt9ZQw',
      yandex: 'http://bit.ly/326H2wL',
    }
  },
  {
    id: '3',
    duration: '3:26',
    name: 'Молчим',
    artist: 'МОНАДА',
    audio: 'audio/leteli_na_yug/06_molchim.mp3',
    cover: 'images/covers/leteli_na_yug.jpg',
    color: 'white',
    links: {
      itunes: 'https://apple.co/2xrMNr4',
      google: 'http://bit.ly/2Nt9ZQw',
      yandex: 'http://bit.ly/326H2wL',
    }
  },
  {
    id: '3',
    duration: '3:57',
    name: 'Теплые ночи',
    artist: 'МОНАДА',
    audio: 'audio/leteli_na_yug/07_teplie_nochi.mp3',
    video: 'https://www.youtube.com/embed/eMNMyYpUgbw',
    cover: 'images/covers/leteli_na_yug.jpg',
    color: 'white',
    links: {
      itunes: 'https://apple.co/2xrMNr4',
      google: 'http://bit.ly/2Nt9ZQw',
      yandex: 'http://bit.ly/326H2wL',
    }
  },
  {
    id: '3',
    duration: '04:46',
    name: 'Чайф',
    artist: 'МОНАДА',
    audio: 'audio/leteli_na_yug/08_chayf.mp3',
    cover: 'images/covers/leteli_na_yug.jpg',
    color: 'white',
    links: {
      itunes: 'https://apple.co/2xrMNr4',
      google: 'http://bit.ly/2Nt9ZQw',
      yandex: 'http://bit.ly/326H2wL',
    }
  },
  {
    id: '0',
    duration: '03:53',
    name: 'Кислород',
    artist: 'МОНАДА',
    audio: 'audio/monada_kislorod.mp3',
    video: 'https://www.youtube.com/embed/iMqvY9xcmHA',
    cover: 'images/covers/kislorod_cover.jpg',
    color: 'white',
    links: {
      itunes: 'https://itunes.apple.com/ru/album/%D0%BA%D0%B8%D1%81%D0%BB%D0%BE%D1%80%D0%BE%D0%B4-single/1460787615',
      google: 'https://play.google.com/store/music/album/%D0%9C%D0%9E%D0%9D%D0%90%D0%94%D0%90_%D0%9A%D0%B8%D1%81%D0%BB%D0%BE%D1%80%D0%BE%D0%B4?id=Bx34qiildeteknoof32asy4tdq4',
      yandex: 'https://music.yandex.ru/album/7357169',
    }
  },
  {
    id: '1',
    duration: '03:25',
    name: 'Дым',
    artist: 'МОНАДА',
    audio: 'audio/monada_dym.mp3',
    video: 'https://www.youtube.com/embed/laYKimBV0YI',
    cover: 'images/covers/dym_cover.jpg',
    color: 'white',
    links: {
      itunes: 'https://itunes.apple.com/ru/album/%D0%B4%D1%8B%D0%BC-single/1452572047',
      google: 'https://play.google.com/store/music/album/%D0%9C%D0%9E%D0%9D%D0%90%D0%94%D0%90_%D0%94%D1%8B%D0%BC?id=Beaviq6jdu3ydtqbo54ky3ax7uq',
      yandex: 'https://music.yandex.ru/album/6876379/track/49961942',
    }
  },
  {
    id: '2',
    duration: '02:53',
    name: 'В моих венах',
    artist: 'МОНАДА',
    audio: 'audio/monada_v_venah.mp3',
    video: 'https://www.youtube.com/embed/d3hz7VoqXzU',
    cover: 'images/covers/v_venah_cover.jpg',
    color: 'black',
    links: {
      itunes: 'https://itunes.apple.com/ru/album/%D0%B2-%D0%BC%D0%BE%D0%B8%D1%85-%D0%B2%D0%B5%D0%BD%D0%B0%D1%85-single/1436967488',
      google: 'https://play.google.com/store/music/album?id=Bjy7smtywxcollytxpasiba3cza&tid=song-Tzmiu3gmhvjglnmk3wxsy6h4gzq',
      yandex: 'https://music.yandex.ru/album/5749693/track/43251618',
    }
  }
];

function pad(num) {
  return ('0' + num).slice(-2);
}

function secToTime(secs) {
  var minutes = Math.floor(secs / 60);
  secs = secs % 60;
  minutes = minutes % 60;

  var paddedSecs = pad(secs);
  var paddedMins = pad(minutes);
  return paddedMins + ':' + paddedSecs;
}

function fadeIn(el) {
  el.style.opacity = 0;

  var last = +new Date();
  var tick = function () {
    el.style.opacity = +el.style.opacity + (new Date() - last) / 400;
    last = +new Date();

    if (+el.style.opacity < 1) {
      (window.requestAnimationFrame && requestAnimationFrame(tick)) || setTimeout(tick, 16);
    }
  };

  tick();
}


(function () {
  function changeCover(activeIndex = 0) {
    const songsContainer = document.querySelectorAll('.song-select');
    songsContainer.forEach((songContainer) => {
      songContainer.classList.add('hide');
    });
    const visibleContainers = document.querySelectorAll('.song-select[data-id="' + activeIndex + '"]');
    visibleContainers.forEach((songContainer) => {
      songContainer.classList.remove('hide');
      fadeIn(songContainer);
    });
  }


  // parallax
  var parallaxContainerName = 'parallax';
  var currentX = '';
  var currentY = '';
  var movementConstant = .01;

  document.addEventListener('mousemove', function (e) {
    if (currentX == '') currentX = e.pageX;
    var xdiff = e.pageX - currentX;
    currentX = e.pageX;
    if (currentY == '') currentY = e.pageY;
    var ydiff = e.pageY - currentY;
    currentY = e.pageY;

    var parallaxItems = document.querySelectorAll('.' + parallaxContainerName + ' div');

    Array.prototype.forEach.call(parallaxItems, function (el, i) {
      var movement = (i + 1) * (xdiff * movementConstant);
      var movementy = (i + 1) * (ydiff * movementConstant);
      var newX = el.offsetLeft + movement;
      var newY = el.offsetTop + movementy;
      el.style.left = newX + 'px';
      el.style.top = newY + 'px';
    });
  });


  var currentSongIndex = 0;
  var player = document.querySelector('.player__audio');
  var cover = document.querySelector('.player__cover');
  var durationTime = document.querySelector('.progress-bar__duration');
  var currentTimeContainer = document.querySelector('.progress-bar__current');
  var songName = document.querySelector('.player__song-name');
  var artist = document.querySelector('.player__artist');
  var firstSong = songs[currentSongIndex];
  var playButton = document.querySelector('.player__play');
  var volumeBar = document.querySelector('.player__volume-bar');
  var progressBar = document.querySelector('.progress-bar__progress--current');
  var nextBtn = document.querySelector('.player__button--next');
  var prevBtn = document.querySelector('.player__button--prev');
  var body = document.querySelector('body');

  updateSongInfo(firstSong, 0);

  function buildPlayList() {
    // todo
    songs.forEach(function (song) {

    })
  }

  // Update the progress bar
  function updateProgressBar(event) {
    var currentTime = parseInt(player.currentTime, 10);
    currentTimeContainer.innerText = secToTime(currentTime);
    // Work out how much of the media has played via the duration and currentTime parameters
    var percentage = Math.floor((100 / player.duration) * player.currentTime);
    if (!percentage) {
      return;
    }
    // Update the progress bar's value
    progressBar.value = percentage;
    // Update the progress bar's text (for browsers that don't support the progress element)
    // progressBar.innerHTML = progressBar.title = percentage + '% played';
  }

  function updateSongInfo(song, index) {
    changeCover(index);
    cover.src = song.cover;
    durationTime.innerText = song.duration;
    songName.innerText = song.name;
    artist.innerText = song.artist;
    player.src = song.audio;
    body.style.color = song.color;
    updateLinks(index);

    if (song.video) {
      var video = document.querySelector('.video-container[data-id="' + index + '"] iframe');
      if (video && !video.src) {
        video.src = song.video;
      }
    }
  }

  function seek(e) {
    if (player.src) {
      var percent = e.offsetX / this.offsetWidth;
      player.currentTime = percent * player.duration;
      e.target.value = Math.floor(percent / 100);
      e.target.innerHTML = progressBar.value + '% played';
    }
  }

  function updateLinks(index) {
    const songsLinks = songs[index].links;
    Object.keys(songsLinks).forEach(function (linkType) {
      const linkTag = document.querySelector('.buy-buttons a[data-id="' + linkType + '"]');
      linkTag.href = songsLinks[linkType];
    });
  }

  function playNextSong() {
    if (player) {
      player.pause();
    }
    var songIndex = currentSongIndex;
    var songsLength = songs.length - 1;
    var nextSongIndex = songIndex === songsLength ? 0 : songIndex + 1;
    var selectedSong = songs[nextSongIndex];
    updateSongInfo(selectedSong, nextSongIndex);
    currentSongIndex = nextSongIndex;
    player.play();
    playButton.classList.add('player__play--paused');
  }

  function playPreviousSong() {
    if (player) {
      player.pause();
    }
    var songIndex = currentSongIndex;
    var songsLength = songs.length - 1;
    var prevSongIndex = songIndex === 0 ? songsLength : songIndex - 1;
    var selectedSong = songs[prevSongIndex];
    updateSongInfo(selectedSong, prevSongIndex);
    currentSongIndex = prevSongIndex;
    player.play();
    playButton.classList.add('player__play--paused');
  }

  playButton.addEventListener('click', (e) => {
    var target = e.target;
    if (!target.classList.contains('player__play--paused')) {
      target.classList.add('player__play--paused');
      player.play();
    } else {
      target.classList.remove('player__play--paused');
      player.pause();
    }
  });

  nextBtn.addEventListener('click', function () {
    playNextSong();
  });

  prevBtn.addEventListener('click', function () {
    playPreviousSong();
  });

  player.addEventListener('timeupdate', updateProgressBar, false);
  progressBar.addEventListener('click', seek);
  player.addEventListener('ended', function () {
    playNextSong()
  }, false);

  // Update the video volume
  volumeBar.addEventListener('input', (e) => {
    player.volume = parseInt(e.target.value) / 100;
  });


})();
